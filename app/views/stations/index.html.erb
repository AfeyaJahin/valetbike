
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
     <style>
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pagination a:focus {
      outline: none;
      box-shadow: none;
    }
    .pagination .current {
      background-color:  #939191;
      color: #8C1627;
      border: 3px solid #939191;
      outline: 2px ridge gray
    }
    .pagination > * {
      margin-right: 1rem;
    }
    .pagination > *:last-child {
      margin-right: 0;
    }
    </style>
  </head>
    <div class="page-section flexbox vertical stretch m-2">
      <div>
        <h1 class="section-title px-6 pt-6">Find A Bike!</h1>
      </div>
    </div>
    
    <div class="container" data-turbo="false" width=100%>
      <div class="flex justify-center m-5">
        <!-- Row -->
        <div style="display: flex;width:100%;flex-direction: row;justify-content: space-between;">
          <div class="w-50% bg-white pr-5 " style="width: 50%;">
            <div class="container mx-auto" position=sticky>
              <form class=" bg-white p-1">
                <div class="mb-4 flex items-center">
                  <%= form_tag(search_stations_path, :method => :get, class: "search-form ") do %>
                  <%= text_field_tag :search, params[:search], placeholder: "Enter a city, zipcode (eg. South Hadley/ 01075)", class: "form-control w-full border border-gray-400" %>
                  <%= submit_tag 'Search', class: 'btn btn-primary ml-2 bg-blue-500 p-2 text-white hover:bg-blue-600', name: nil %>
                  <% end %>
                </div>
              </form>
            </div>
            <div id="stations-list" >
              <div class="grid grid-rows-1 gap-2 mt-2 md:grid-rows-2"  >
                <% if @stations.present? %>
                  <%= render(partial: "station_row", collection: @stations, as: :station) %>
                <% else %>
                <div class="empty">
                  No stations found.
                </div>
                <% end %>
                <div id="pagination" class="lg:flex">
                  <div class="container" style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 1rem;">
                      <span>Showing <%= @stations.offset + 1 %> - <%= @stations.offset + @stations.length %> of <%= @stations.total_entries %> entries</span>      
                      <div class = "btn_group ml-2">
                      <%= will_paginate @stations %>
                      </div>
                  </div>
                </div>
              </div> 
            </div>
          </div>

          <script>
            <%= render(partial: 'paginate', formats: [:js]) %>
          </script>

          <script>
            var geocoder;
            var map;
            function initMap() {
              navigator.geolocation.getCurrentPosition(function(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;
                
                var latlng = new google.maps.LatLng(latitude, longitude);
                  
                const blueIcon = {
                  url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                  scaledSize: new google.maps.Size(35, 35),
                  origin: new google.maps.Point(0, 0),
                  anchor: new google.maps.Point(25, 50),
                };
                map = new google.maps.Map(document.getElementById('map'), {
                  zoom: 14,
                  center: latlng
                });
                geocoder = new google.maps.Geocoder();

                geocoder.geocode({ 'latLng': latlng }, function(results, status) {
                    if (status === 'OK') {
                    var marker = new google.maps.Marker({
                      map: map,
                      position: results[0].geometry.location,
                      icon: blueIcon,
                      title: "Your location"
                    });
                  } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                  }
                });

                addStations()
                
              });

            }

            function addStations() {
              let all_stations = <%=@all_stations.to_json.html_safe%>;
              let page_stations = <%=@stations.to_json.html_safe%>;
              const infoWindow = new google.maps.InfoWindow();

              for (let station of all_stations) {
                const stationLatLng = { lat: Number(station["latitude"]), lng: Number(station["longitude"]) };
                const docked_bikes_id = station["id"] + "_docked"
                const station_element = document.getElementById(`${docked_bikes_id}`);

                const isPageStation = () => {
                  var x;
                  for (x of page_stations) {
                    if (x["identifier"] === station["identifier"]){
                      return true
                    }
                  }
                  return false
                }

                const marker = new google.maps.Marker({
                  map: map,
                  position: stationLatLng,
                  title: `${station["name"]}`,
                  label: `${station["identifier"]}`,
                  animation: null,
                  optimized: false,
                });

                if (isPageStation()) {
                  map.setCenter(stationLatLng);

                  const contentString =
                    "<div>" +
                    `<h1>${station["name"]}</h1>` +
                    '<div id="bodyContent" justify=space-between>' +
                    `<p>${station["address"]}</p>` +
                    `<p>${station_element.getAttribute('value')}</p>` +
                    '<p>Total Docks: 10</p>' +
                    "</div>" +
                    "</div>";

                  marker.addListener("click", () => {
                    infoWindow.close();
                    infoWindow.setContent(contentString);
                    infoWindow.open(marker.getMap(), marker);
                  });

                  marker.setAnimation(google.maps.Animation.BOUNCE);
                }
              }
            }
          </script>

          <div id="map" class="px-5 lg:w-1/2" style="max-height: 100%">
            <% maps_api_key = "AIzaSyCp5mAqPHORth7ssHydyqRCwDjIuLnHT_E"%>
            <script async
              src="https://maps.googleapis.com/maps/api/js?key=<%= maps_api_key%>&libraries=places&callback=initMap">
            </script>
          </div>

        </div>
      </div>
    </div>
